name: CI/CD Pipeline

on:
  push:
    branches: ["develop"] # develop ë¸Œëœì¹˜ì— pushë  ë•Œ (PR merge í¬í•¨)
  pull_request:
    branches: ["develop"] # developìœ¼ë¡œ PR ìƒì„±ì‹œ CIë§Œ ì‹¤í–‰

jobs:
  # CI Job - í…ŒìŠ¤íŠ¸ ì‹¤í–‰
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      # - name: Create application-secret.yml
      #   run: |
      #     mkdir -p ./src/main/resources
      #     cd ./src/main/resources
      #     echo "${{ secrets.YML_SECRET }}" | base64 --decode > ./application-secret.yml
      #     chmod 644 ./application-secret.yml
      #   shell: bash

      - name: Set up JDK 21
        uses: actions/setup-java@v3
        with:
          java-version: "21"
          distribution: "corretto"

      - name: Cache Gradle dependencies
        uses: actions/cache@v3
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}

      - name: Grant execute permission for gradlew
        run: chmod +x ./gradlew

      - name: Run tests
        run: ./gradlew clean test

      - name: Build application
        run: ./gradlew build -x test

      - name: Upload build artifacts
        if: github.ref == 'refs/heads/develop' && github.event_name == 'push'
        uses: actions/upload-artifact@v4
        with:
          name: jar-artifact
          path: build/libs/*.jar
          retention-days: 1

  # CD Job - ë°°í¬ ì‹¤í–‰ (develop ë¸Œëœì¹˜ì— pushë  ë•Œë§Œ)
  deploy:
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/develop' && github.event_name == 'push'

    steps:
      - name: Download build artifacts
        uses: actions/download-artifact@v3
        with:
          name: jar-artifact
          path: ./

      - name: Deploy to EC2
        uses: appleboy/ssh-action@v0.1.5
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          port: 22
          script: |
            # ì•± ë””ë ‰í† ë¦¬ ìƒì„±
            mkdir -p ~/app/backup

            # ê¸°ì¡´ ì• í”Œë¦¬ì¼€ì´ì…˜ ì¤‘ì§€
            echo "Stopping existing application..."
            sudo pkill -f 'java.*jar' || echo "No running application found"
            sleep 5

            # ê¸°ì¡´ JAR ë°±ì—…
            if [ -f ~/app/app.jar ]; then
              mv ~/app/app.jar ~/app/backup/app-backup-$(date +%Y%m%d_%H%M%S).jar
              echo "Previous version backed up"
            fi

      - name: Copy JAR to EC2
        uses: appleboy/scp-action@v0.1.4
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          port: 22
          source: "*.jar"
          target: "~/app/"

      - name: Start Application
        uses: appleboy/ssh-action@v0.1.5
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          port: 22
          script: |
            cd ~/app

            # JAR íŒŒì¼ëª…ì„ ì¼ê´€ë˜ê²Œ ë³€ê²½
            mv *.jar app.jar 2>/dev/null || echo "JAR file already named correctly"

            # ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹œì‘
            echo "Starting application..."
            nohup java -Xmx512m -Xms256m -jar app.jar --spring.profiles.active=prod > app.log 2>&1 &

            # ì‹œì‘ í™•ì¸
            sleep 15

            if pgrep -f "java.*app.jar" > /dev/null; then
              echo "âœ… Application started successfully!"
              echo "Process ID: $(pgrep -f 'java.*app.jar')"
              
              # í—¬ìŠ¤ ì²´í¬ (ì„ íƒì‚¬í•­)
              sleep 10
              if curl -f http://localhost:8080/actuator/health 2>/dev/null; then
                echo "âœ… Health check passed!"
              else
                echo "âš ï¸ Application started but health check failed"
              fi
            else
              echo "âŒ Application failed to start!"
              echo "Recent logs:"
              tail -20 app.log
              exit 1
            fi

  # ë°°í¬ ì„±ê³µ ì•Œë¦¼ (ì„ íƒì‚¬í•­)
  notify:
    needs: [test, deploy]
    runs-on: ubuntu-latest
    if: always() && github.ref == 'refs/heads/develop' && github.event_name == 'push'

    steps:
      - name: Notify deployment result
        run: |
          if [ "${{ needs.deploy.result }}" == "success" ]; then
            echo "ğŸš€ Deployment to EC2 completed successfully!"
          else
            echo "âŒ Deployment failed!"
          fi
